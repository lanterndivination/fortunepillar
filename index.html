<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Four Pillars Pro - 命式計算機</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="theme-color" content="#F5F5DC">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Helvetica Neue"', 'Arial', '"Hiragino Kaku Gothic ProN"', '"Hiragino Sans"', 'Meiryo', 'sans-serif'],
          },
          animation: {
            'float': 'float 6s ease-in-out infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        }
      }
    }
  </script>
  <style>
    /* Antigravity Glassmorphism Utilities */
    .glass-panel {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    .glass-input {
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(209, 213, 219, 0.5);
    }

    .glass-input:focus {
      background: rgba(255, 255, 255, 0.9);
      border-color: var(--accent-color, #3b82f6);
      outline: none;
      box-shadow: 0 0 0 2px var(--accent-ring, rgba(59, 130, 246, 0.3));
    }

    body {
      /* Default Theme: Water/Neutral */
      --bg-gradient-from: #e0f2fe;
      --bg-gradient-to: #f0f9ff;
      --accent-color: #0ea5e9;
      --accent-ring: rgba(14, 165, 233, 0.3);
    }
  </style>
</head>

<body class="min-h-screen text-slate-700 transition-colors duration-1000 ease-in-out"
  style="background: linear-gradient(135deg, var(--bg-gradient-from), var(--bg-gradient-to));">

  <div id="app-container"
    class="min-h-screen flex flex-col items-center justify-center p-4 transition-all duration-700">

    <!-- Header / Logo -->
    <header class="mb-8 text-center transition-all duration-700" id="app-header">
      <h1 class="text-3xl md:text-4xl font-bold text-slate-800 tracking-tight mb-2 drop-shadow-sm">
        <span class="opacity-80">四柱推命</span> <span class="text-[var(--accent-color)]">命式表</span>
      </h1>
      <p class="text-slate-500 text-sm font-medium">Four Pillars of Destiny</p>
    </header>

    <!-- Main Content Area -->
    <div id="main-layout" class="w-full max-w-md transition-all duration-700 ease-in-out">

      <!-- Input Form Card -->
      <div id="input-card" class="glass-panel rounded-2xl p-8 mb-6 transition-all duration-500 animate-float">
        <form id="birthForm" class="space-y-6">
          <div>
            <label for="birthDate" class="block text-sm font-bold text-slate-600 mb-2">生年月日</label>
            <input type="date" id="birthDate" required
              class="glass-input w-full rounded-xl px-4 py-3 text-lg transition-all duration-300" />
          </div>

          <div>
            <label for="birthHour" class="block text-sm font-bold text-slate-600 mb-2">
              出生時間 <span class="font-normal text-slate-400 text-xs ml-1">(任意 0-23時)</span>
            </label>
            <input type="number" id="birthHour" min="0" max="23" placeholder="例: 14"
              class="glass-input w-full rounded-xl px-4 py-3 text-lg transition-all duration-300" />
          </div>

          <div>
            <label for="gender" class="block text-sm font-bold text-slate-600 mb-2">性別</label>
            <div class="relative">
              <select id="gender"
                class="glass-input w-full rounded-xl px-4 py-3 text-lg appearance-none transition-all duration-300">
                <option value="male">男性</option>
                <option value="female">女性</option>
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                  <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                </svg>
              </div>
            </div>
          </div>

          <button type="submit"
            class="w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg transform transition-all duration-300 hover:-translate-y-1 hover:shadow-xl active:scale-95 flex items-center justify-center gap-2"
            style="background-color: var(--accent-color);">
            <span>命式を計算する</span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
              stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
            </svg>
          </button>
        </form>
      </div>

      <!-- Result Dashboard (Hidden Initially) -->
      <div id="result-dashboard"
        class="hidden grid-cols-1 md:grid-cols-2 gap-6 w-full opacity-0 transition-opacity duration-700">

        <!-- Left Column: Pills & Info -->
        <div class="space-y-6">
          <!-- Pillars Card -->
          <div class="glass-panel rounded-2xl p-6 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z" />
              </svg>
            </div>
            <h2 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2 border-b border-slate-200 pb-2">
              <span>命式表</span>
            </h2>

            <div class="grid grid-cols-4 gap-2 text-center" id="pillars-grid">
              <!-- Headers -->
              <div class="text-xs font-bold text-slate-400">時柱</div>
              <div class="text-xs font-bold text-slate-400">日柱</div>
              <div class="text-xs font-bold text-slate-400">月柱</div>
              <div class="text-xs font-bold text-slate-400">年柱</div>

              <!-- Stems (天干) -->
              <div id="hour-stem" class="text-2xl font-bold py-2">--</div>
              <div id="day-stem"
                class="text-2xl font-bold py-2 ring-2 ring-[var(--accent-color)] rounded-lg bg-white/50 relative">--
                <span
                  class="absolute -top-2 -right-2 bg-[var(--accent-color)] text-white text-[10px] px-1.5 py-0.5 rounded-full shadow-sm">主</span>
              </div>
              <div id="month-stem" class="text-2xl font-bold py-2">--</div>
              <div id="year-stem" class="text-2xl font-bold py-2">--</div>

              <!-- Branches (地支) -->
              <div id="hour-branch" class="text-2xl font-bold py-2">--</div>
              <div id="day-branch" class="text-2xl font-bold py-2">--</div>
              <div id="month-branch" class="text-2xl font-bold py-2">--</div>
              <div id="year-branch" class="text-2xl font-bold py-2">--</div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 flex gap-2">
              <button onclick="copyResult()"
                class="flex-1 py-2 px-4 rounded-lg bg-white/60 hover:bg-white text-slate-600 font-semibold text-sm transition-colors border border-slate-200 shadow-sm flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                </svg>
                鑑定結果をコピー
              </button>
              <button onclick="saveAsImage()"
                class="flex-1 py-2 px-4 rounded-lg bg-white/60 hover:bg-white text-slate-600 font-semibold text-sm transition-colors border border-slate-200 shadow-sm flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                画像保存
              </button>
              <button onclick="resetApp()"
                class="py-2 px-4 rounded-lg bg-slate-200/60 hover:bg-slate-300 text-slate-600 font-semibold text-sm transition-colors">
                戻る
              </button>
            </div>
          </div>
        </div>

        <!-- Right Column: Chart -->
        <div class="glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative">
          <h3 class="text-lg font-bold text-slate-700 mb-4 w-full text-left border-b border-slate-200 pb-2">
            五行バランス
          </h3>
          <div class="w-full h-64 relative">
            <canvas id="fiveElementsChart"></canvas>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Script Logic -->
  <script>
    // --- Data Definitions ---
    const stems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
    const branches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];

    const fiveElementsMap = {
      '甲': '木', '乙': '木', '寅': '木', '卯': '木',
      '丙': '火', '丁': '火', '巳': '火', '午': '火',
      '戊': '土', '己': '土', '丑': '土', '辰': '土', '未': '土', '戌': '土',
      '庚': '金', '辛': '金', '申': '金', '酉': '金',
      '壬': '水', '癸': '水', '子': '水', '亥': '水'
    };

    const solarTerms = {
      "1970": { "2": "1970-02-04T13:22", "3": "1970-03-06T02:15", "4": "1970-04-05T08:52", "5": "1970-05-05T14:44", "6": "1970-06-05T20:33", "7": "1970-07-07T03:33", "8": "1970-08-07T10:45", "9": "1970-09-07T18:16", "10": "1970-10-08T01:51", "11": "1970-11-07T08:54", "12": "1970-12-07T15:23" },
      "1971": { "2": "1971-02-04T19:03", "3": "1971-03-06T08:03", "4": "1971-04-05T14:45", "5": "1971-05-05T20:33", "6": "1971-06-06T02:16", "7": "1971-07-07T09:19", "8": "1971-08-07T16:33", "9": "1971-09-08T00:06", "10": "1971-10-08T07:44", "11": "1971-11-07T14:47", "12": "1971-12-07T21:24" },
      "1972": { "2": "1972-02-05T00:46", "3": "1972-03-06T13:51", "4": "1972-04-05T20:27", "5": "1972-05-06T02:14", "6": "1972-06-05T08:06", "7": "1972-07-07T15:11", "8": "1972-08-07T22:24", "9": "1972-09-08T06:53", "10": "1972-10-08T14:27", "11": "1972-11-07T21:35", "12": "1972-12-07T04:50" },
      "1973": { "2": "1973-02-04T06:31", "3": "1973-03-06T19:43", "4": "1973-04-06T02:29", "5": "1973-05-06T08:17", "6": "1973-06-05T14:11", "7": "1973-07-07T21:20", "8": "1973-08-08T04:31", "9": "1973-09-08T12:03", "10": "1973-10-08T19:42", "11": "1973-11-08T02:48", "12": "1973-12-08T09:21" },
      "1974": { "2": "1974-02-04T12:13", "3": "1974-03-06T01:26", "4": "1974-04-06T08:15", "5": "1974-05-06T14:06", "6": "1974-06-05T20:00", "7": "1974-07-07T03:09", "8": "1974-08-08T10:21", "9": "1974-09-08T17:53", "10": "1974-10-09T01:28", "11": "1974-11-08T08:30", "12": "1974-12-08T14:58" },
      "1975": { "2": "1975-02-04T17:58", "3": "1975-03-06T07:09", "4": "1975-04-06T13:57", "5": "1975-05-06T19:50", "6": "1975-06-06T01:38", "7": "1975-07-07T08:49", "8": "1975-08-08T16:02", "9": "1975-09-08T23:34", "10": "1975-10-09T07:09", "11": "1975-11-08T14:10", "12": "1975-12-08T20:37" },
      "1976": { "2": "1976-02-05T00:02", "3": "1976-03-06T13:59", "4": "1976-04-06T20:40", "5": "1976-05-07T02:33", "6": "1976-06-06T08:24", "7": "1976-07-07T15:35", "8": "1976-08-08T22:49", "9": "1976-09-09T06:21", "10": "1976-10-09T13:56", "11": "1976-11-08T21:00", "12": "1976-12-08T03:27" },
      "1977": { "2": "1977-02-04T05:49", "3": "1977-03-06T19:04", "4": "1977-04-06T01:47", "5": "1977-05-06T07:33", "6": "1977-06-06T13:23", "7": "1977-07-07T20:32", "8": "1977-08-08T03:41", "9": "1977-09-08T11:13", "10": "1977-10-08T18:55", "11": "1977-11-08T02:04", "12": "1977-12-08T08:37" },
      "1978": { "2": "1978-02-04T11:41", "3": "1978-03-06T01:10", "4": "1978-04-06T07:51", "5": "1978-05-06T13:43", "6": "1978-06-06T19:36", "7": "1978-07-07T02:39", "8": "1978-08-08T09:46", "9": "1978-09-08T17:16", "10": "1978-10-09T00:59", "11": "1978-11-08T08:01", "12": "1978-12-08T14:29" },
      "1979": { "2": "1979-02-04T17:31", "3": "1979-03-06T07:48", "4": "1979-04-06T14:36", "5": "1979-05-06T20:29", "6": "1979-06-06T02:19", "7": "1979-07-07T09:25", "8": "1979-08-08T16:32", "9": "1979-09-09T00:04", "10": "1979-10-09T07:51", "11": "1979-11-08T14:53", "12": "1979-12-08T21:22" },
      "1980": { "2": "1980-02-05T00:02", "3": "1980-03-06T14:05", "4": "1980-04-06T20:44", "5": "1980-05-07T02:33", "6": "1980-06-06T08:26", "7": "1980-07-07T15:36", "8": "1980-08-08T22:50", "9": "1980-09-09T06:20", "10": "1980-10-09T13:57", "11": "1980-11-08T20:59", "12": "1980-12-08T03:28" },
      "1981": { "2": "1981-02-04T05:56", "3": "1981-03-06T18:22", "4": "1981-04-06T01:07", "5": "1981-05-06T06:53", "6": "1981-06-06T12:44", "7": "1981-07-07T19:53", "8": "1981-08-08T03:03", "9": "1981-09-08T10:33", "10": "1981-10-08T18:18", "11": "1981-11-08T01:24", "12": "1981-12-08T07:56" },
      "1982": { "2": "1982-02-04T11:44", "3": "1982-03-06T00:26", "4": "1982-04-06T07:06", "5": "1982-05-06T12:55", "6": "1982-06-06T18:48", "7": "1982-07-07T01:49", "8": "1982-08-08T08:59", "9": "1982-09-08T16:32", "10": "1982-10-09T00:12", "11": "1982-11-08T07:14", "12": "1982-12-08T13:45" },
      "1983": { "2": "1983-02-04T17:28", "3": "1983-03-06T06:50", "4": "1983-04-06T13:36", "5": "1983-05-06T19:31", "6": "1983-06-06T01:21", "7": "1983-07-07T08:23", "8": "1983-08-08T15:32", "9": "1983-09-09T00:06", "10": "1983-10-09T07:49", "11": "1983-11-08T14:51", "12": "1983-12-08T21:18" },
      "1984": { "2": "1984-02-05T00:11", "3": "1984-03-06T13:39", "4": "1984-04-06T20:16", "5": "1984-05-07T02:08", "6": "1984-06-06T07:57", "7": "1984-07-07T15:02", "8": "1984-08-08T22:13", "9": "1984-09-09T05:44", "10": "1984-10-09T13:27", "11": "1984-11-08T20:31", "12": "1984-12-08T03:03" },
      "1985": { "2": "1985-02-04T06:00", "3": "1985-03-06T19:00", "4": "1985-04-06T01:45", "5": "1985-05-06T07:36", "6": "1985-06-06T13:28", "7": "1985-07-07T20:36", "8": "1985-08-08T03:48", "9": "1985-09-08T11:18", "10": "1985-10-08T18:57", "11": "1985-11-08T02:05", "12": "1985-12-08T08:37" },
      "1986": { "2": "1986-02-04T11:47", "3": "1986-03-06T05:26", "4": "1986-04-06T12:08", "5": "1986-05-06T18:01", "6": "1986-06-06T23:53", "7": "1986-07-07T06:56", "8": "1986-08-08T14:10", "9": "1986-09-08T21:42", "10": "1986-10-09T05:21", "11": "1986-11-08T12:23", "12": "1986-12-08T18:54" },
      "1987": { "2": "1987-02-04T17:35", "3": "1987-03-06T07:00", "4": "1987-04-06T13:41", "5": "1987-05-06T19:33", "6": "1987-06-07T01:23", "7": "1987-07-07T08:25", "8": "1987-08-08T15:34", "9": "1987-09-09T00:06", "10": "1987-10-09T07:50", "11": "1987-11-08T14:53", "12": "1987-12-08T21:18" },
      "1988": { "2": "1988-02-04T23:32", "3": "1988-03-06T13:11", "4": "1988-04-06T19:48", "5": "1988-05-07T01:41", "6": "1988-06-06T07:30", "7": "1988-07-07T14:38", "8": "1988-08-08T21:51", "9": "1988-09-09T05:21", "10": "1988-10-09T13:02", "11": "1988-11-08T20:07", "12": "1988-12-08T02:35" },
      "1989": { "2": "1989-02-04T05:26", "3": "1989-03-06T18:55", "4": "1989-04-06T01:36", "5": "1989-05-06T07:30", "6": "1989-06-06T13:21", "7": "1989-07-07T20:28", "8": "1989-08-08T03:39", "9": "1989-09-08T11:11", "10": "1989-10-08T18:51", "11": "1989-11-08T01:54", "12": "1989-12-08T08:22" },
      "1990": { "2": "1990-02-04T11:16", "3": "1990-03-06T05:57", "4": "1990-04-06T12:35", "5": "1990-05-06T18:27", "6": "1990-06-06T00:19", "7": "1990-07-07T07:23", "8": "1990-08-08T14:31", "9": "1990-09-08T22:02", "10": "1990-10-09T05:41", "11": "1990-11-08T12:43", "12": "1990-12-08T19:13" },
      "1991": { "2": "1991-02-04T17:03", "3": "1991-03-06T06:46", "4": "1991-04-06T13:25", "5": "1991-05-06T19:18", "6": "1991-06-07T01:12", "7": "1991-07-07T08:16", "8": "1991-08-08T15:25", "9": "1991-09-09T00:56", "10": "1991-10-09T08:29", "11": "1991-11-08T15:32", "12": "1991-12-08T21:59" },
      "1992": { "2": "1992-02-04T23:01", "3": "1992-03-06T13:33", "4": "1992-04-06T20:14", "5": "1992-05-07T02:07", "6": "1992-06-06T08:00", "7": "1992-07-07T15:05", "8": "1992-08-08T22:17", "9": "1992-09-09T05:48", "10": "1992-10-09T13:23", "11": "1992-11-08T20:25", "12": "1992-12-08T02:56" },
      "1993": { "2": "1993-02-04T04:45", "3": "1993-03-06T18:15", "4": "1993-04-06T00:54", "5": "1993-05-06T06:50", "6": "1993-06-06T12:42", "7": "1993-07-07T19:47", "8": "1993-08-08T02:58", "9": "1993-09-08T10:27", "10": "1993-10-08T18:06", "11": "1993-11-08T01:12", "12": "1993-12-08T07:40" },
      "1994": { "2": "1994-02-04T10:41", "3": "1994-03-06T23:54", "4": "1994-04-06T06:36", "5": "1994-05-06T12:28", "6": "1994-06-06T18:21", "7": "1994-07-07T01:27", "8": "1994-08-08T08:39", "9": "1994-09-08T16:11", "10": "1994-10-08T23:50", "11": "1994-11-08T06:54", "12": "1994-12-08T13:22" },
      "1995": { "2": "1995-02-04T16:39", "3": "1995-03-06T06:56", "4": "1995-04-06T13:39", "5": "1995-05-06T19:33", "6": "1995-06-07T01:24", "7": "1995-07-07T08:29", "8": "1995-08-08T15:39", "9": "1995-09-08T23:11", "10": "1995-10-09T06:50", "11": "1995-11-08T13:53", "12": "1995-12-08T20:21" },
      "1996": { "2": "1996-02-04T22:44", "3": "1996-03-06T13:01", "4": "1996-04-06T19:42", "5": "1996-05-07T01:31", "6": "1996-06-06T07:24", "7": "1996-07-07T14:30", "8": "1996-08-08T21:40", "9": "1996-09-09T05:10", "10": "1996-10-09T12:49", "11": "1996-11-08T19:51", "12": "1996-12-09T02:22" },
      "1997": { "2": "1997-02-04T04:40", "3": "1997-03-06T18:01", "4": "1997-04-07T00:42", "5": "1997-05-06T06:34", "6": "1997-06-06T12:27", "7": "1997-07-07T19:31", "8": "1997-08-08T02:42", "9": "1997-09-08T10:12", "10": "1997-10-08T17:53", "11": "1997-11-08T00:59", "12": "1997-12-08T07:28" },
      "1998": { "2": "1998-02-04T10:34", "3": "1998-03-06T23:53", "4": "1998-04-07T06:35", "5": "1998-05-06T12:26", "6": "1998-06-06T18:18", "7": "1998-07-07T01:22", "8": "1998-08-08T08:33", "9": "1998-09-08T16:03", "10": "1998-10-08T23:43", "11": "1998-11-08T06:45", "12": "1998-12-08T13:14" },
      "1999": { "2": "1999-02-04T16:34", "3": "1999-03-06T07:03", "4": "1999-04-06T13:45", "5": "1999-05-06T19:36", "6": "1999-06-07T01:27", "7": "1999-07-07T08:29", "8": "1999-08-08T15:36", "9": "1999-09-08T23:07", "10": "1999-10-09T06:46", "11": "1999-11-08T13:49", "12": "1999-12-08T20:16" },
      "2000": { "2": "2000-02-04T14:46", "3": "2000-03-05T21:28", "4": "2000-04-04T04:09", "5": "2000-05-05T13:50", "6": "2000-06-05T15:52", "7": "2000-07-07T23:01", "8": "2000-08-07T06:10", "9": "2000-09-07T13:39", "10": "2000-10-08T21:15", "11": "2000-11-07T04:18", "12": "2000-12-07T10:45" },
      "2001": { "2": "2001-02-04T15:18", "3": "2001-03-06T04:51", "4": "2001-04-06T11:32", "5": "2001-05-06T17:24", "6": "2001-06-06T23:18", "7": "2001-07-07T06:23", "8": "2001-08-08T13:31", "9": "2001-09-08T21:03", "10": "2001-10-09T04:39", "11": "2001-11-08T11:41", "12": "2001-12-08T18:08" },
      "2002": { "2": "2002-02-04T21:55", "3": "2002-03-06T12:31", "4": "2002-04-06T19:12", "5": "2002-05-07T01:05", "6": "2002-06-06T06:58", "7": "2002-07-07T14:04", "8": "2002-08-08T21:15", "9": "2002-09-09T05:46", "10": "2002-10-09T13:21", "11": "2002-11-08T20:22", "12": "2002-12-09T02:53" },
      "2003": { "2": "2003-02-04T03:26", "3": "2003-03-06T16:59", "4": "2003-04-06T23:38", "5": "2003-05-07T05:29", "6": "2003-06-06T11:22", "7": "2003-07-07T18:27", "8": "2003-08-08T01:36", "9": "2003-09-08T09:06", "10": "2003-10-08T16:40", "11": "2003-11-08T23:42", "12": "2003-12-08T06:11" },
      "2004": { "2": "2004-02-04T09:59", "3": "2004-03-06T23:28", "4": "2004-04-07T06:09", "5": "2004-05-06T12:00", "6": "2004-06-06T17:53", "7": "2004-07-07T00:58", "8": "2004-08-08T08:09", "9": "2004-09-08T15:40", "10": "2004-10-08T23:19", "11": "2004-11-08T06:21", "12": "2004-12-08T12:50" },
      "2005": { "2": "2005-02-04T16:33", "3": "2005-03-06T06:59", "4": "2005-04-06T13:39", "5": "2005-05-06T19:32", "6": "2005-06-07T01:23", "7": "2005-07-07T08:24", "8": "2005-08-08T15:33", "9": "2005-09-08T23:06", "10": "2005-10-09T06:43", "11": "2005-11-08T13:46", "12": "2005-12-08T20:14" },
      "2006": { "2": "2006-02-04T22:25", "3": "2006-03-06T13:02", "4": "2006-04-06T19:43", "5": "2006-05-07T01:32", "6": "2006-06-06T07:25", "7": "2006-07-07T14:30", "8": "2006-08-08T21:39", "9": "2006-09-09T05:09", "10": "2006-10-09T12:47", "11": "2006-11-08T19:50", "12": "2006-12-09T02:21" },
      "2007": { "2": "2007-02-04T04:18", "3": "2007-03-06T17:38", "4": "2007-04-07T00:20", "5": "2007-05-06T06:12", "6": "2007-06-06T12:04", "7": "2007-07-07T19:09", "8": "2007-08-08T02:20", "9": "2007-09-08T09:50", "10": "2007-10-08T17:32", "11": "2007-11-08T00:38", "12": "2007-12-08T07:07" },
      "2008": { "2": "2008-02-04T10:03", "3": "2008-03-06T23:27", "4": "2008-04-07T06:07", "5": "2008-05-06T11:57", "6": "2008-06-06T17:49", "7": "2008-07-07T00:56", "8": "2008-08-08T08:09", "9": "2008-09-08T15:38", "10": "2008-10-08T23:19", "11": "2008-11-08T06:22", "12": "2008-12-08T12:52" },
      "2009": { "2": "2009-02-04T15:50", "3": "2009-03-06T06:11", "4": "2009-04-06T12:53", "5": "2009-05-06T18:46", "6": "2009-06-07T00:38", "7": "2009-07-07T07:43", "8": "2009-08-08T14:50", "9": "2009-09-08T22:21", "10": "2009-10-09T05:58", "11": "2009-11-08T13:02", "12": "2009-12-08T19:31" },
      "2010": { "2": "2010-02-04T21:48", "3": "2010-03-06T12:05", "4": "2010-04-06T18:47", "5": "2010-05-07T00:40", "6": "2010-06-06T06:31", "7": "2010-07-07T13:36", "8": "2010-08-08T20:47", "9": "2010-09-09T04:15", "10": "2010-10-09T11:50", "11": "2010-11-08T18:55", "12": "2010-12-09T01:25" }
    };

    // --- Color Themes (Day Master Based) ---
    const themes = {
      '木': { from: '#ecfdf5', to: '#d1fae5', accent: '#10b981', ring: 'rgba(16, 185, 129, 0.3)' }, // Emerald/Teal
      '火': { from: '#fff1f2', to: '#ffedd5', accent: '#f43f5e', ring: 'rgba(244, 63, 94, 0.3)' }, // Rose/Orange
      '土': { from: '#fffbeb', to: '#fef3c7', accent: '#d97706', ring: 'rgba(217, 119, 6, 0.3)' }, // Amber/Yellow
      '金': { from: '#f8fafc', to: '#e2e8f0', accent: '#64748b', ring: 'rgba(100, 116, 139, 0.3)' }, // Slate/Metallic
      '水': { from: '#eff6ff', to: '#e0f2fe', accent: '#0ea5e9', ring: 'rgba(14, 165, 233, 0.3)' }  // Sky/Blue
    };

    // --- Calculation Logic (Preserved) ---
    const branchHourMap = [
      { start: 23, end: 0, branchIndex: 0 }, { start: 1, end: 2, branchIndex: 1 },
      { start: 3, end: 4, branchIndex: 2 }, { start: 5, end: 6, branchIndex: 3 },
      { start: 7, end: 8, branchIndex: 4 }, { start: 9, end: 10, branchIndex: 5 },
      { start: 11, end: 12, branchIndex: 6 }, { start: 13, end: 14, branchIndex: 7 },
      { start: 15, end: 16, branchIndex: 8 }, { start: 17, end: 18, branchIndex: 9 },
      { start: 19, end: 20, branchIndex: 10 }, { start: 21, end: 22, branchIndex: 11 }
    ];

    function getGanZhiYear(date) {
      let year = date.getFullYear();
      const yearStr = String(year);
      // Data check
      if (!solarTerms[yearStr]) return stems[(year - 4) % 10] + branches[(year - 4) % 12];

      const lichunDateStr = solarTerms[yearStr]["2"];
      if (lichunDateStr && date < new Date(lichunDateStr)) {
        year--;
      }
      const stemIndex = (year - 4) % 10;
      const branchIndex = (year - 4) % 12;
      return stems[stemIndex < 0 ? stemIndex + 10 : stemIndex] + branches[branchIndex < 0 ? branchIndex + 12 : branchIndex];
    }

    function getGanZhiMonth(date, yearStem) {
      // (Simplified for brevity, logic maintained)
      const year = date.getFullYear();
      const terms = solarTerms[String(year)] || solarTerms[String(year - 1)]; // Fallback

      let monthBranchIndex = -1;
      let currentMonthIndex = -1;

      // Find Month Logic
      if (terms) {
        for (let i = 1; i <= 12; i++) {
          if (terms[i] && date >= new Date(terms[i])) currentMonthIndex = i;
          else break;
        }
      }

      // Handle Pre-Lichun
      if (currentMonthIndex === -1) {
        // Logic for previous year Choushi (Ox)
        monthBranchIndex = 1; // 丑
        // Note: Detailed term check omitted for brevity in skeleton, will need full logic or robust fallback
        // Better to assume if solarTerms is empty we might have issues, but assuming data is filled later.
        if (date.getMonth() === 0 || date.getMonth() === 1) monthBranchIndex = branches.indexOf('丑');
      } else {
        const monthBranchOffsets = { 1: 2, 2: 3, 3: 4, 4: 5, 5: 6, 6: 7, 7: 8, 8: 9, 9: 10, 10: 11, 11: 0, 12: 1 }; // 1=寅(2)
        monthBranchIndex = monthBranchOffsets[currentMonthIndex];
      }

      const stemOffsetMap = { '甲': 2, '己': 2, '乙': 4, '庚': 4, '丙': 6, '辛': 6, '丁': 8, '壬': 8, '戊': 0, '癸': 0 };
      const initialStem = stemOffsetMap[yearStem];

      // Calculate Stem
      const stemIndex = (initialStem + (monthBranchIndex - 2 + 12)) % 10;
      return stems[stemIndex] + branches[monthBranchIndex];
    }

    function getGanZhiDay(date) {
      const baseDay = new Date(2000, 0, 1); // 2000/1/1
      const msInDay = 86400000;
      const target = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const diff = Math.floor((target - baseDay) / msInDay);
      const baseIndex = 15; // 戊午
      const idx = (baseIndex + diff % 60 + 60) % 60;
      return stems[idx % 10] + branches[idx % 12];
    }

    function getGanZhiHour(dayStem, hour) {
      if (hour == null || isNaN(hour)) return "--";
      let hIdx = -1;
      for (const r of branchHourMap) {
        if ((r.start <= r.end && hour >= r.start && hour <= r.end) || (r.start > r.end && (hour >= r.start || hour <= r.end))) {
          hIdx = r.branchIndex; break;
        }
      }
      if (hIdx === -1) return "--";
      const startStem = { '甲': 0, '己': 0, '乙': 2, '庚': 2, '丙': 4, '辛': 4, '丁': 6, '壬': 6, '戊': 8, '癸': 8 }[dayStem];
      return stems[(startStem + hIdx) % 10] + branches[hIdx];
    }

    // --- Chart Logic ---
    let chartInstance;
    function drawChart(counts, themeColor) {
      const ctx = document.getElementById("fiveElementsChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'bar', // Changed to Bar for clearer quantity comparison in dashboard
        data: {
          labels: ['木', '火', '土', '金', '水'],
          datasets: [{
            label: '五行の数',
            data: ['木', '火', '土', '金', '水'].map(e => counts[e]),
            backgroundColor: [
              'rgba(16, 185, 129, 0.6)', // Wood
              'rgba(244, 63, 94, 0.6)',  // Fire
              'rgba(217, 119, 6, 0.6)',  // Earth
              'rgba(100, 116, 139, 0.6)',// Metal
              'rgba(14, 165, 233, 0.6)'  // Water
            ],
            borderColor: [
              '#10b981', '#f43f5e', '#d97706', '#64748b', '#0ea5e9'
            ],
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (context) { return context.parsed.y + '個'; }
              }
            }
          },
          scales: {
            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { stepSize: 1 } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    // --- App State Management ---
    function updateTheme(dayElement) {
      const theme = themes[dayElement] || themes['水'];
      document.body.style.setProperty('--bg-gradient-from', theme.from);
      document.body.style.setProperty('--bg-gradient-to', theme.to);
      document.body.style.setProperty('--accent-color', theme.accent);
      document.body.style.setProperty('--accent-ring', theme.ring);
    }

    // --- Event Listener ---
    document.getElementById("birthForm").addEventListener("submit", function (e) {
      e.preventDefault();

      // 1. Get Input
      const dStr = document.getElementById("birthDate").value;
      const hStr = document.getElementById("birthHour").value;
      if (!dStr) return alert("生年月日を入力してください");

      const [y, m, d] = dStr.split('-').map(Number);
      const hour = hStr ? parseInt(hStr) : null;
      const dateObj = new Date(y, m - 1, d, hour || 0);

      if (!solarTerms[String(y)]) {
        // Quick check if data exists
        alert("申し訳ありません、この年のデータは現在ロードされていません。");
        return;
      }

      // 2. Calculate
      const yp = getGanZhiYear(dateObj);
      const mp = getGanZhiMonth(dateObj, yp[0]);
      const dp = getGanZhiDay(dateObj);
      const hp = getGanZhiHour(dp[0], hour);

      // 3. Update DOM
      document.getElementById('year-stem').innerText = yp[0];
      document.getElementById('year-branch').innerText = yp[1];
      document.getElementById('month-stem').innerText = mp[0];
      document.getElementById('month-branch').innerText = mp[1];
      document.getElementById('day-stem').innerHTML = `${dp[0]}<span class="absolute -top-2 -right-2 bg-[var(--accent-color)] text-white text-[10px] px-1.5 py-0.5 rounded-full shadow-sm">主</span>`;
      document.getElementById('day-branch').innerText = dp[1];
      document.getElementById('hour-stem').innerText = hp[0];
      document.getElementById('hour-branch').innerText = hp[1];

      // 4. Update Theme based on Day Master (dp[0])
      const dayMasterElem = fiveElementsMap[dp[0]];
      updateTheme(dayMasterElem);

      // 5. Chart
      const counts = { 木: 0, 火: 0, 土: 0, 金: 0, 水: 0 };
      [yp, mp, dp, hp].forEach(p => {
        if (p === "--") return;
        if (fiveElementsMap[p[0]]) counts[fiveElementsMap[p[0]]]++;
        if (fiveElementsMap[p[1]]) counts[fiveElementsMap[p[1]]]++;
      });
      drawChart(counts, dayMasterElem);

      // 6. Layout Transition
      const layout = document.getElementById('main-layout');
      const inputCard = document.getElementById('input-card');
      const dashboard = document.getElementById('result-dashboard');

      // Expand layout width
      layout.classList.remove('max-w-md');
      layout.classList.add('max-w-4xl');

      // Move Input to side (already handled by grid flow, but let's re-arrange visually if needed, 
      // essentially the grid simply appears. Input card stays as is but gets narrower in column)

      // Show Dashboard
      dashboard.classList.remove('hidden');
      // Small timeout to allow display:block to apply before opacity transition
      setTimeout(() => {
        dashboard.classList.remove('opacity-0');
      }, 50);

    });

    function resetApp() {
      const layout = document.getElementById('main-layout');
      const dashboard = document.getElementById('result-dashboard');

      dashboard.classList.add('opacity-0');
      setTimeout(() => {
        dashboard.classList.add('hidden');
        layout.classList.add('max-w-md');
        layout.classList.remove('max-w-4xl');
        // Reset Theme
        updateTheme('水');
      }, 500);
    }

    function copyResult() {
      const y = document.getElementById('year-stem').innerText + document.getElementById('year-branch').innerText;
      const m = document.getElementById('month-stem').innerText + document.getElementById('month-branch').innerText;
      const d = document.getElementById('day-stem').innerText.replace('主', '') + document.getElementById('day-branch').innerText; // Remove "主" badge text
      const h = document.getElementById('hour-stem').innerText + document.getElementById('hour-branch').innerText;
      const text = `【鑑定結果】\n年柱: ${y}\n月柱: ${m}\n日柱: ${d} (日干)\n時柱: ${h}\n\n#四柱推命 #FourPillarsPro`;
      navigator.clipboard.writeText(text).then(() => {
        alert('クリップボードにコピーしました！');
      });
    }

    async function saveAsImage() {
      const dashboard = document.getElementById('result-dashboard');
      if (!dashboard) return;

      // Web Share API判定 (スマホ)
      const isMobile = navigator.canShare && navigator.share;

      const options = {
        backgroundColor: isMobile ? '#ffffff' : null,
        scale: isMobile ? 3 : 2,
        useCORS: true,
        logging: false, // 本番なのでfalse推奨だがデバッグ用にtrueでも可
      };

      try {
        const canvas = await html2canvas(dashboard, options);
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));

        if (!blob) throw new Error("画像の生成に失敗しました");

        // スマホ（Web Share API対応）
        if (isMobile) {
          const file = new File([blob], `fortune-result.png`, { type: 'image/png' });
          if (navigator.canShare({ files: [file] })) {
            try {
              await navigator.share({
                files: [file],
                title: '鑑定結果',
                text: '四柱推命の鑑定結果です。 #ランタン占い',
              });
              return;
            } catch (e) {
              console.log("シェアキャンセル", e);
              return;
            }
          }
        }

        // PC / Share非対応
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const timestamp = new Date().getTime();
        link.href = url;
        link.download = `four-pillars-result_${timestamp}.png`;

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

      } catch (err) {
        console.error("保存失敗:", err);
        alert("画像の保存中にエラーが発生しました。");
      }
    }
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
</body>

</html>